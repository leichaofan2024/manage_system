<%= render "attendance_sidebar"%>
<h4>考勤表状态：</h4>
<% if (current_user.has_role? :groupadmin) || (current_user.has_role? :organsadmin) %>
  <h4><%= link_to "导出表格", group_attendances_path(format: "xls")%></h4>
  <%= link_to "点击申请", "#", class: "btn btn-primary", "data-toggle" => "modal", "data-target" => "#applicationModal" %>
  <%= form_tag filter_attendances_path, method: 'get' do %>
    <%= label_tag :请输入时间段搜索 %>
    <%= select_tag(:year, options_for_select(@years.collect{ |u| u }), {:required => "true"}) %> ~
    <%= select_tag(:month, options_for_select(@months.collect{ |u| u }), {:required => "true"}) %>
    <%= hidden_field_tag :type, "group" %>
    <%= submit_tag :筛选 %>
  <% end %>
<% end %>
<div class="card">
  <div style="overflow: auto; width: 100%;">
    <table id="example" class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th>姓名</th>
          <th>职名</th>
          <!-- 生成每月1-31号的数字-开始 -->
          <% (1..31).each do |i| %>
            <th><%= i %></th>
          <% end %>
          <!-- 生成每月1-31号的数字-结束 -->
          <% @vacation_codes.each do |code| %>
            <th><%= VacationCategory.find_by(:vacation_code => code).vacation_name %></th>
          <% end %>
        </tr>
      </thead>
        <tbody data-behavior='sortable'>
        <!-- 配置表格数据-开始 -->
          <% @employees.each do |employee| %>
            <!-- 声明后面需要用到的hash -->
            <% attendance_hash = {} %>
            <!-- 将维表中存放的代表每种考勤名称的字母赋值给attendance_codes -->
            <tr>
              <td><%= employee.id %></td>
              <td><%= employee.name %></td>
              <td><%= employee.duty %></td>
              <!-- 捞出当前员工的考勤数据，数据可以为多个，可以为空 -->
              <% if @year.present? && @month.present? %>
                <% attendance = Attendance.find_by(employee_id: employee.id, month: @month, year: @year) %>
              <% else %>
                <% attendance = Attendance.find_by(employee_id: employee.id, month: Time.now.month, year: Time.now.year) %>
              <% end %>
              <!-- 将现员的考勤数据（字符串格式）拆分成数组，赋值给attendance_ary -->
              <% if attendance.present? %>
                <% attendance_ary = attendance.month_attendances.split('') %>
                <!-- 将attendance_ary进行迭代，每一个就是一个员工每天的考勤数据 -->
                <% day_number = 1%>
                <% attendance_ary.each do |day_attendance| %>
                  <!-- 在维表VacationCategory中通过vacation_code找到对应的考勤简写名称，放入表格 -->
                  <% time_range = (Time.now.day - 3)..(Time.now.day) %>
                    <% if time_range === day_number %>
                      <td>
                        <% if @year.present? && @month.present? %>
                          <%= link_to show_modal_attendances_path(employee_id: employee.id, month: @month, year: @year, day_number: day_number), remote: true, class: "btn btn-primary", "data-toggle" => "modal", "data-target" => "#myModal" do %>
                            <% if day_attendance == "x" %>
                              <%= day_number %>
                            <% else %>
                              <%= VacationCategory.find_by(:vacation_code => day_attendance).vacation_shortening %>
                            <% end %>
                          <% end %>
                        <% else %>
                          <%= link_to show_modal_attendances_path(employee_id: employee.id, month: Time.now.month, year: Time.now.year, day_number: day_number), remote: true, class: "btn btn-primary", "data-toggle" => "modal", "data-target" => "#myModal" do %>
                            <% if day_attendance == "x" %>
                              <%= "未考勤" %>
                            <% else %>
                              <%= VacationCategory.find_by(:vacation_code => day_attendance).vacation_shortening %>
                            <% end %>
                          <% end %>
                        <% end %>
                      </td>
                    <% else %>
                      <td>
                        <% if day_attendance == "x" %>
                          <%= ""%>
                        <% else %>
                          <%= VacationCategory.find_by(:vacation_code => day_attendance).vacation_shortening %>
                        <% end %>
                      </td>
                    <% end %>
                  <% day_number += 1%>
                <% end %>
                <% @vacation_codes.each do |code| %>
                  <td><%= AttendanceCount.where(:vacation_code => code, :employee_id => employee.id).sum(:count) %></td>
                <% end %>
              <% end %>
            </tr>
          <% end %>
          <!-- 配置表格数据-开始 -->
       </tbody>
    </table>
    <div id="showModal">
    </div>
   </div>
  </div>
 </div>
</div>
<%= render 'application_modal' %>
