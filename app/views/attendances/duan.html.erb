<h4>本考勤表状态:</h4>
<%= link_to "通过审核", verify_attendances_path(authority: "duan", workshop: @workshop), method: :post, class: "btn btn-primary" %>
<%= link_to "一键审核全部", batch_verify_attendances_path(authority: "duan"), method: :post, class: "btn btn-primary pull-right" %>
<div class="col-md-12" style="height: 100%">
    <div class="col-md-2" id="menu" style="background-color: white;overflow: auto;height: 100%;">
      <h5><%= link_to "北京供电段", duan_attendances_path(duan: "北京供电段") %></h5>
      <ul>
        <% @workshops.each do |workshop| %>
        <li>
          <em></em><a href='/attendances/duan?workshop=<%= workshop.id %>'><%= workshop.name %></a>
          <ul>
            <% @groups = workshop.groups %>
            <% @groups.each do |group| %>
              <li><a href='/attendances/duan?group=<%= group.id %>'><%= group.name %></a></li>
            <% end %>
          </ul>
        </li>
        <% end %>
      </ul>
    </div>

<div class="card">
  <div style="overflow: auto;" class="col-md-10">
    <table id="example" class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <% if @workshop.present? %>
            <th>班组</th>
          <% elsif @group.present? %>
            <th>姓名</th>
            <th>工资号</th>
            <th>车间</th>
            <th>班组</th>
          <% else %>
            <th>车间</th>
          <% end %> 
          <% @vacation_codes.each do |code| %>
            <th><%= VacationCategory.find_by(:vacation_code => code).vacation_name %></th>
          <% end %>    
        </tr>
      </thead>
        <tbody data-behavior='sortable'>        
          <% if @workshop.present? %>
            <% Group.where(:workshop_id => @workshop).each do |group| %>
              <tr>
                <td><%= group.id %></td>
                <td><%= group.name %></td>
                <% @vacation_codes.each do |code| %>
                  <% count = AttendanceCount.where(:group_id => group.id, :vacation_code => code).sum(:count) %>
                  <% if count == 0 %>
                    <td><%= count %></td>
                  <% else %>
                    <td><%= link_to count, duan_detail_attendances_path(code: code, group: group.id), class: "btn btn-primary" %></td>
                  <% end %>
                <% end %>
              </tr>
            <% end %>
          <% elsif @group.present? %>
            <% Employee.where(:group => @group).each do |employee| %>
              <tr>
                <td><%= employee.id %></td>
                <td><%= employee.name %></td>
                <td><%= employee.sal_number %></td>
                <td><%= Workshop.find(employee.workshop).name %></td>
                <td><%= Group.find(employee.group).name %></td>
                <% @vacation_codes.each do |code| %>
                  <td><%= AttendanceCount.where(:employee_id => employee.id, :vacation_code => code).sum(:count) %></td>
                <% end %>
              </tr>
            <% end %>
          <% else %>
            <% Workshop.all.each do |workshop| %>
              <tr>
                <td><%= workshop.id %></td>
                <td><%= workshop.name %></td>
                <% @vacation_codes.each do |code| %>
                  <td><%= AttendanceCount.where(:workshop_id => workshop.id, :vacation_code => code).sum(:count) %></td>
                <% end %>
              </tr>
            <% end %>
          <% end %>      
       </tbody>
    </table>
  </div>
</div>
</div>

<script type="text/javascript">
      (function(e) {
        for(var _obj=document.getElementById(e.id).getElementsByTagName(e.tag),i=-1,em;em=_obj[++i];){
          em.onclick = function(){ //onmouseover
            var ul = this.nextSibling;
            if(!ul){
              return false;
            }
            ul = ul.nextSibling;
            if(!ul) {
              return false;
            }
            if(e.tag != 'a') {
              ul = ul.nextSibling;
              if(!ul){
                return false;
              }
            } //a 标签控制 隐藏或删除该行
            for(var _li=this.parentNode.parentNode.childNodes,n=-1,li;li=_li[++n];) {
              if(li.tagName=="LI"){
                for(var _ul=li.childNodes,t=-1,$ul;$ul=_ul[++t];){
                  switch($ul.tagName){
                    case "UL": $ul.className = $ul!=ul?"" : ul.className?"":"off";
                    break;
                    case "EM": $ul.className = $ul!=this?"" : this.className?"":"off";
                    break;
                  }
                }
              }
            }
          }
        }
      })({id:'menu',tag:'em'});
    </script>